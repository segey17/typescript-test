// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  avatar    String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  anime           Anime[]           @relation("CreatedBy")
  ratings         Rating[]
  comments        Comment[]
  commentLikes    CommentLike[]
  animeStatuses   UserAnimeStatus[]
  loginAttempts   LoginAttempt[]

  @@map("users")
}

model Anime {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  genre       String?
  year        Int?
  studio      String?
  imageUrl    String?  @map("image_url")
  trailerUrl  String?  @map("trailer_url")
  createdBy   Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  creator       User?             @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  ratings       Rating[]
  comments      Comment[]
  userStatuses  UserAnimeStatus[]

  @@map("anime")
}

model Rating {
  id               Int      @id @default(autoincrement())
  userId           Int      @map("user_id")
  animeId          Int      @map("anime_id")
  storyRating      Int      @map("story_rating")
  artRating        Int      @map("art_rating")
  charactersRating Int      @map("characters_rating")
  soundRating      Int      @map("sound_rating")
  overallRating    Float?   @map("overall_rating")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId], name: "unique_user_anime")
  @@map("ratings")
}

model Comment {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  animeId   Int      @map("anime_id")
  comment   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime Anime         @relation(fields: [animeId], references: [id], onDelete: Cascade)
  likes CommentLike[]

  @@map("comments")
}

model CommentLike {
  id        Int         @id @default(autoincrement())
  userId    Int         @map("user_id")
  commentId Int         @map("comment_id")
  likeType  LikeType    @map("like_type")
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId], name: "unique_user_comment")
  @@map("comment_likes")
}

model UserAnimeStatus {
  id        Int              @id @default(autoincrement())
  userId    Int              @map("user_id")
  animeId   Int              @map("anime_id")
  status    WatchingStatus
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  anime Anime @relation(fields: [animeId], references: [id], onDelete: Cascade)

  @@unique([userId, animeId], name: "unique_user_anime_status")
  @@map("user_anime_status")
}

model LoginAttempt {
  id             Int       @id @default(autoincrement())
  username       String
  ipAddress      String    @map("ip_address")
  failedAttempts Int       @default(0) @map("failed_attempts")
  lastAttempt    DateTime  @default(now()) @updatedAt @map("last_attempt")
  blockedUntil   DateTime? @map("blocked_until")
  blockLevel     Int       @default(0) @map("block_level")
  createdAt      DateTime  @default(now()) @map("created_at")
  userId         Int?      @map("user_id")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([username])
  @@index([blockedUntil])
  @@map("login_attempts")
}

// Enums
enum UserRole {
  USER  @map("user")
  ADMIN @map("admin")
}

enum LikeType {
  LIKE    @map("like")
  DISLIKE @map("dislike")
}

enum WatchingStatus {
  PLANNED   @map("planned")
  WATCHING  @map("watching")
  COMPLETED @map("completed")
  DROPPED   @map("dropped")
}
